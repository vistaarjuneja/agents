# Feature Flag Cleanup Agent

## Overview

The **Feature Flag Cleanup Agent** automatically removes stale feature flags from a repository during a CI pipeline run. The agent analyzes code behind a specified feature flag and treatment, removes flag evaluations, and keeps only the selected code path. It then opens a draft pull request with a summary of the changes.

The goal is to keep the codebase clean and automate safe cleanup of stale feature flags through the pipeline.

---

## Key Capabilities

- üîç **Flag Reference Detection**
  - Searches the repository for references to the specified feature flag
  - Tracks related exported constants and dependent files

- üßπ **Safe Code Cleanup**
  - Removes feature flag evaluations and conditional branches
  - Keeps only the code path for the selected treatment
  - Removes unused variables, imports, and clients when no longer needed

- üîÅ **Pull Request Automation**
  - Creates draft pull requests with human-readable summaries
  - Generates branch name, commit message, PR title, and PR description
  - Pushes changes and opens a PR through Harness Code

---

## Usage

### Prerequisites

- Access to the target repository
- Anthropic API key configured as a secret
- Harness API key with permission to create pull requests

### How it works

1. Provide a feature flag name and optional treatment
2. The pipeline generates a cleanup task file
3. The coding agent:
  - finds flag references
  - updates files in place
  - writes PR metadata files
4. The pipeline creates a branch, commits changes, pushes to origin, and opens a draft pull request

---

## Inputs

| Input           | Type   | Required | Default                     | Description |
| --------------- | ------ | -------- | --------------------------- | ----------- |
| `anthropicKey`  | secret | Yes      | `ffcleanup_anthropic_apikey` | Anthropic API key used by the coding agent |
| `harnessApiKey` | secret | Yes      | `ffcleanup_harness_apikey`   | Harness API key used to create the pull request |
| `featureFlag`   | string | Yes      | -                           | Feature flag to clean up |
| `treatment`     | string | No       | `on`                        | Treatment to keep when removing evaluations |
| `repo`          | string | Yes      | -                           | Repository to clone and modify |
| `branch`        | string | No       | `main`                      | Base branch to clone |

---

## Outputs

- New branch with feature flag cleanup changes
- Draft pull request created in Harness Code
- PR metadata files generated by the agent:
  - `/harness/temp-pipeline/branch.txt`
  - `/harness/temp-pipeline/commit.txt`
  - `/harness/temp-pipeline/pr_title.txt`
  - `/harness/temp-pipeline/pr_description.txt`

---

## Troubleshooting

- **Coding agent fails to start**
  - Verify `anthropicKey` is configured and valid

- **Branch push fails**
  - Check repository permissions and SCM authentication

- **Pull request creation fails**
  - Verify `harnessApiKey` permissions and repository identifiers
